#!/usr/bin/env bash
DOCKER_VERSION_RESPONSE=$(docker -v)
EXPECTED_RESPONSE="Docker version "
if test "${DOCKER_VERSION_RESPONSE#*$EXPECTED_RESPONSE}" != "$DOCKER_VERSION_RESPONSE"; then

  if [ -z "$CODEINSPECT_GIT_SSHKEY" ]; then
    export CODEINSPECT_GIT_SSHKEY="$HOME/.ssh/id_rsa"
  fi
  if [ -z "$CODEINSPECT_CONTAINER" ]; then
    export CODEINSPECT_CONTAINER="CodeInspect"
  fi
  export CODEINSPECT_CONTAINER=${CODEINSPECT_CONTAINER// /_}
  if [ -z "$CODEINSPECT_IMAGE" ]; then
    export CODEINSPECT_IMAGE="shibme/codeinspect"
    docker pull "$CODEINSPECT_IMAGE"
  fi

  CODEINSPECT_COMMAND="docker run --rm "
  CODEINSPECT_COMMAND="$CODEINSPECT_COMMAND -e CODEINSPECT_PROJECT"
  CODEINSPECT_COMMAND="$CODEINSPECT_COMMAND -e CODEINSPECT_DIR"
  CODEINSPECT_COMMAND="$CODEINSPECT_COMMAND -e CODEINSPECT_CONTEXT"
  CODEINSPECT_COMMAND="$CODEINSPECT_COMMAND -e CODEINSPECT_LANG"
  CODEINSPECT_COMMAND="$CODEINSPECT_COMMAND -e CODEINSPECT_TOOL"
  CODEINSPECT_COMMAND="$CODEINSPECT_COMMAND -e CODEINSPECT_BUILDSCRIPT"
  CODEINSPECT_COMMAND="$CODEINSPECT_COMMAND -e CODEINSPECT_GIT_REPO"
  CODEINSPECT_COMMAND="$CODEINSPECT_COMMAND -e CODEINSPECT_GIT_BRANCH"
  CODEINSPECT_COMMAND="$CODEINSPECT_COMMAND -e CODEINSPECT_GIT_COMMIT"
  CODEINSPECT_COMMAND="$CODEINSPECT_COMMAND -e CODEINSPECT_GIT_USERNAME"
  CODEINSPECT_COMMAND="$CODEINSPECT_COMMAND -e CODEINSPECT_GIT_TOKEN"
  CODEINSPECT_COMMAND="$CODEINSPECT_COMMAND -e STEWARD_CONFIG"
  CODEINSPECT_COMMAND="$CODEINSPECT_COMMAND -e STEWARD_PROJECT_KEY"
  CODEINSPECT_COMMAND="$CODEINSPECT_COMMAND -e STEWARD_ISSUE_TYPE"
  CODEINSPECT_COMMAND="$CODEINSPECT_COMMAND -e STEWARD_PRIORITY_P0"
  CODEINSPECT_COMMAND="$CODEINSPECT_COMMAND -e STEWARD_PRIORITY_P1"
  CODEINSPECT_COMMAND="$CODEINSPECT_COMMAND -e STEWARD_PRIORITY_P2"
  CODEINSPECT_COMMAND="$CODEINSPECT_COMMAND -e STEWARD_PRIORITY_P3"
  CODEINSPECT_COMMAND="$CODEINSPECT_COMMAND -e STEWARD_PRIORITY_P4"
  CODEINSPECT_COMMAND="$CODEINSPECT_COMMAND -e STEWARD_TRACKER_NAME"
  CODEINSPECT_COMMAND="$CODEINSPECT_COMMAND -e STEWARD_TRACKER_ENDPOINT"
  CODEINSPECT_COMMAND="$CODEINSPECT_COMMAND -e STEWARD_TRACKER_USERNAME"
  CODEINSPECT_COMMAND="$CODEINSPECT_COMMAND -e STEWARD_TRACKER_PASSWORD"
  CODEINSPECT_COMMAND="$CODEINSPECT_COMMAND -e STEWARD_TRACKER_API_KEY"
  CODEINSPECT_COMMAND="$CODEINSPECT_COMMAND -e STEWARD_DRY_RUN"
  CODEINSPECT_COMMAND="$CODEINSPECT_COMMAND -e STEWARD_EXIT_CODE_NEW_ISSUES"
  CODEINSPECT_COMMAND="$CODEINSPECT_COMMAND -e STEWARD_EXIT_CODE_FAILURE"
  CODEINSPECT_COMMAND="$CODEINSPECT_COMMAND -e STEWARD_UPDATE_TITLE"
  CODEINSPECT_COMMAND="$CODEINSPECT_COMMAND -e STEWARD_UPDATE_DESCRIPTION"
  CODEINSPECT_COMMAND="$CODEINSPECT_COMMAND -e STEWARD_UPDATE_LABELS"
  CODEINSPECT_COMMAND="$CODEINSPECT_COMMAND -e STEWARD_PRIORITIZE_UP"
  CODEINSPECT_COMMAND="$CODEINSPECT_COMMAND -e STEWARD_PRIORITIZE_DOWN"
  CODEINSPECT_COMMAND="$CODEINSPECT_COMMAND -e STEWARD_ASSIGNEE"
  CODEINSPECT_COMMAND="$CODEINSPECT_COMMAND -e STEWARD_REOPEN_STATUS"
  CODEINSPECT_COMMAND="$CODEINSPECT_COMMAND -e STEWARD_RESOLVED_STATUSES"
  CODEINSPECT_COMMAND="$CODEINSPECT_COMMAND -e STEWARD_CLOSED_STATUSES"
  CODEINSPECT_COMMAND="$CODEINSPECT_COMMAND -e STEWARD_IGNORE_LABELS"
  CODEINSPECT_COMMAND="$CODEINSPECT_COMMAND -e STEWARD_IGNORE_STATUSES"
  CODEINSPECT_COMMAND="$CODEINSPECT_COMMAND -e STEWARD_AUTO_REOPEN_AFTER"
  CODEINSPECT_COMMAND="$CODEINSPECT_COMMAND -e STEWARD_AUTO_REOPEN_TRANSITION"
  CODEINSPECT_COMMAND="$CODEINSPECT_COMMAND -e STEWARD_AUTO_REOPEN_COMMENT"
  CODEINSPECT_COMMAND="$CODEINSPECT_COMMAND -e STEWARD_AUTO_RESOLVE_AFTER"
  CODEINSPECT_COMMAND="$CODEINSPECT_COMMAND -e STEWARD_AUTO_RESOLVE_TRANSITION"
  CODEINSPECT_COMMAND="$CODEINSPECT_COMMAND -e STEWARD_AUTO_RESOLVE_COMMENT"
  CODEINSPECT_COMMAND="$CODEINSPECT_COMMAND --name $CODEINSPECT_CONTAINER"
  if [ -f "$CODEINSPECT_GIT_SSHKEY" ]; then
    echo "Using SSH Key: $CODEINSPECT_GIT_SSHKEY"
    CODEINSPECT_COMMAND="$CODEINSPECT_COMMAND -v $CODEINSPECT_GIT_SSHKEY:/root/.ssh/id_rsa"
  fi
  CODEINSPECT_COMMAND="$CODEINSPECT_COMMAND -v $(pwd):/codeinspect $CODEINSPECT_IMAGE"

  echo "Starting container: $CODEINSPECT_CONTAINER"
  echo "$CODEINSPECT_COMMAND" | bash
else
  echo "Please install docker client before you begin."
  exit 1
fi
